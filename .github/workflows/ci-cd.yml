name: MyTripStyle CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'ë°°í¬ í™˜ê²½ ì„ íƒ'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  NODE_VERSION: '16'
  REACT_APP_ENV: ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}

jobs:
  build:
    name: ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v3

      - name: Node.js ${{ env.NODE_VERSION }} ì„¤ì •
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci
      
      - name: ë¦°íŠ¸ ê²€ì‚¬
        run: npm run lint
        continue-on-error: true
      
      - name: ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: npm test -- --coverage
      
      - name: í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ë³´ê³ ì„œ ìƒì„±
        uses: coverallsapp/github-action@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ë¹Œë“œ
        run: npm run build
        env:
          REACT_APP_ENV: ${{ env.REACT_APP_ENV }}
          REACT_APP_FIREBASE_API_KEY: ${{ secrets.FIREBASE_API_KEY }}
          REACT_APP_FIREBASE_AUTH_DOMAIN: ${{ secrets.FIREBASE_AUTH_DOMAIN }}
          REACT_APP_FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          REACT_APP_FIREBASE_STORAGE_BUCKET: ${{ secrets.FIREBASE_STORAGE_BUCKET }}
          REACT_APP_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}
          REACT_APP_FIREBASE_APP_ID: ${{ secrets.FIREBASE_APP_ID }}
          REACT_APP_OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          REACT_APP_WEATHER_API_KEY: ${{ secrets.WEATHER_API_KEY }}
          REACT_APP_SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
      
      - name: ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ì €ì¥
        uses: actions/upload-artifact@v3
        with:
          name: build-files
          path: build/
          retention-days: 1
      
      - name: ë°°í¬ ì„±ê³µ ì•Œë¦¼
        if: success()
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "âœ… MyTripStyle ìŠ¤í…Œì´ì§• í™˜ê²½ ë°°í¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\nì»¤ë°‹: ${{ github.event.head_commit.message }}\në°°í¬ì: ${{ github.actor }}"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  deploy-staging:
    name: ìŠ¤í…Œì´ì§• í™˜ê²½ ë°°í¬
    needs: build
    if: |
      success() && 
      (github.ref == 'refs/heads/develop' || 
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging'))
    runs-on: ubuntu-latest
    environment: staging
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v3
      
      - name: ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v3
        with:
          name: build-files
          path: build
      
      - name: Firebase CLI ì„¤ì •
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: '${{ secrets.GITHUB_TOKEN }}'
          firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT_STAGING }}'
          projectId: my-trip-style-staging
          channelId: live
        env:
          FIREBASE_CLI_PREVIEWS: hostingchannels
      
      - name: ë°°í¬ ì„±ê³µ ì•Œë¦¼
        if: success()
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "âœ… MyTripStyle ìŠ¤í…Œì´ì§• í™˜ê²½ ë°°í¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\nì»¤ë°‹: ${{ github.event.head_commit.message }}\në°°í¬ì: ${{ github.actor }}"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  deploy-production:
    name: í”„ë¡œë•ì…˜ í™˜ê²½ ë°°í¬
    needs: build
    if: |
      success() && 
      (github.ref == 'refs/heads/main' || 
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production'))
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v3
      
      - name: ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v3
        with:
          name: build-files
          path: build
      
      - name: Firebase CLI ì„¤ì •
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: '${{ secrets.GITHUB_TOKEN }}'
          firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT_PROD }}'
          projectId: my-trip-style-prod
          channelId: live
        env:
          FIREBASE_CLI_PREVIEWS: hostingchannels
      
      - name: í”„ë¡œë•ì…˜ ë°°í¬ ìŠ¬ë™ ì•Œë¦¼
        if: success()
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "ğŸš€ MyTripStyle í”„ë¡œë•ì…˜ í™˜ê²½ ë°°í¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\nì»¤ë°‹: ${{ github.event.head_commit.message }}\në°°í¬ì: ${{ github.actor }}"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  cloudflare-purge:
    name: CDN ìºì‹œ ë¬´íš¨í™”
    needs: [deploy-staging, deploy-production]
    if: |
      always() &&
      (needs.deploy-staging.result == 'success' || needs.deploy-production.result == 'success')
    runs-on: ubuntu-latest
    steps:
      - name: CloudFlare ìºì‹œ ë¬´íš¨í™”
        uses: jakejarvis/cloudflare-purge-action@master
        env:
          CLOUDFLARE_ZONE: ${{ secrets.CLOUDFLARE_ZONE }}
          CLOUDFLARE_TOKEN: ${{ secrets.CLOUDFLARE_TOKEN }}
      
      - name: ìºì‹œ ë¬´íš¨í™” ì•Œë¦¼
        if: success()
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "ğŸ”„ CloudFlare CDN ìºì‹œê°€ ì„±ê³µì ìœ¼ë¡œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤."
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
  
  notify-failure:
    name: ì‹¤íŒ¨ ì•Œë¦¼
    needs: [build, deploy-staging, deploy-production, cloudflare-purge]
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: ë°°í¬ ì‹¤íŒ¨ ì•Œë¦¼
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "âŒ MyTripStyle CI/CD íŒŒì´í”„ë¼ì¸ì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤!\nì‘ì—…: ${{ github.workflow }}\nì»¤ë°‹: ${{ github.event.head_commit.message }}\nì‹¤í–‰ì: ${{ github.actor }}\nìì„¸í•œ ë‚´ìš©ì€ GitHub Actions ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”."
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
